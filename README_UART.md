# README_UART.md

Этот файл описывает UART-подсистему проекта `primGPT` для `STM32F411` (BlackPill): прием/передача, таймаут кадра и связь ISR с задачами FreeRTOS.

---

## 1) Какие UART используются

- `USART1` - командный интерфейс (RX/TX протокола).
- `USART6` - отладочный/лог-канал.

Основная логика протокола работает через `USART1`.

### Текущие настройки

Для `USART1`:
- `38400`, `8N1`, `UART_MODE_TX_RX`;
- прием по прерыванию `HAL_UART_Receive_IT(..., 1 byte)`;
- IRQ: `USART1_IRQn`.

Для `USART6`:
- `115200`, `8N1`, `UART_MODE_TX_RX`;
- используется в основном как TX для логов (`log_printf`, `printf_uart3`).

---

## 2) Как устроен прием в коде

Поток данных:

1. Стартует прием 1 байта: `HAL_UART_Receive_IT(&huart1, ..., 1)`.
2. После каждого байта вызывается `HAL_UART_RxCpltCallback()`.
3. ISR кладет байт в `uartQueue` через `xQueueSendFromISR`.
4. `Uart1Task` читает очередь (`xQueueReceive`) и собирает кадр.

Это RTOS-правильный шаблон: ISR короткая, разбор протокола в задаче.

---

## 3) Как определяется конец кадра

Конец кадра определяется по паузе между байтами:

- ISR обновляет `last_rx_time = xTaskGetTickCountFromISR();`
- задача считает `diff = xTaskGetTickCount() - last_rx_time`
- если `index > 0` и `diff > UART_TIMEOUT_MS`, кадр считается завершенным.

Текущее значение:

- `UART_TIMEOUT_MS = 20` (см. `Core/Inc/DataFile.h`).

---

## 4) Буфер и CRC

- Размер буфера кадра: `UART_BUF_SIZE = 100`.
- Проверка целостности: `CRC16` (`polynomial = 0xA001`).
- Входной кадр валиден, если `process_crc(..., true) == 1`.

Ответ формируется как 2 байта данных + 2 байта CRC:

- `[ID_BU, 0x00] + CRC16`.

---

## 5) Что важно для стабильности

- Всегда перезапускать прием в callback: `HAL_UART_Receive_IT(...)`.
- Использовать только ISR-safe API в прерывании (`...FromISR`).
- Не выполнять тяжелую логику/`HAL_Delay` в ISR.
- Для логов использовать ограниченный буфер и безопасную длину передачи.

---

## 6) Текущая диагностика по UART6

В `StartDefaultTask` раз в 5 секунд выводятся:

- `HeapB F:... Min:... Tot:...`
- `HeapU now:... peak:...`
- `StkB free D:... L:... U:...`
- `StkU % D:... L:... U:...`

Это позволяет контролировать heap/stack в runtime, а не только по ощущениям.
